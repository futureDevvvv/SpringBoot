<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.softsociety.issho.chat.dao.ChatDAO">

	<select id="chatList" parameterType="Map" resultType="Chatroom">
		SELECT
		c.chatroom_seq as chatroom_seq, c.chatroom_name as chatroom_name,
		(SELECT MAX(chatmsg_sendDate) FROM chatmsg) as chatmsg_senddate
		FROM chatroom c LEFT OUTER JOIN chatmember m
		ON(c.chatroom_seq = m.chatroom_seq)
		LEFT OUTER JOIN chatmsg g
		ON (c.chatroom_seq = c.chatroom_seq)
		WHERE c.prj_domain = #{prj_domain} AND m.chat_member= #{chat_member}
	</select>

	<insert id="openNewChat" parameterType="Chatroom">
		INSERT INTO
		chatroom(chatroom_seq, chatroom_name, prj_domain)
		VALUES(#{chatroom_seq}, #{chatroom_name}, #{prj_domain})
	</insert>

	<insert id="addChatMem" parameterType="Chatroom">
		INSERT INTO chatmember
		VALUES(#{chatroom_seq}, #{chat_member})
	</insert>
	
	<select id="chatMemList" parameterType="String" resultType="Members">
		SELECT * FROM chatmember
		WHERE chatroom_seq=#{chatroom_seq}
	</select>
	
	<select id="chatMsgs" parameterType="String" resultType="ChatMsg">
		SELECT * FROM chatmsg
		WHERE chatroom_seq=#{chatroom_seq}
	</select>
	
	<insert id="insertMsg" parameterType="ChatMsg">
		INSERT INTO chatmsg
		VALUES(#{chatroom_seq}, chatmsg_seq.NEXTVAL, #{chatmsg_recipient}, sysdate, #{chatmsg_content})
	</insert>

</mapper>