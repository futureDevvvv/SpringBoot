<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<th:block th:replace="fragments/config :: head"></th:block>
<meta charset="UTF-8">
<title>Insert title here</title>
<script th:src="@{/js/sockjs.min.js}"></script>
<script th:inline="javascript">
	let roomId = [[${roomId}]];
	let sock = new SockJS("../../../ws/multiRoom");
	
	console.log(sock);
	console.log(roomId);
	
	//onopen 함수는 페이지가 로드되면 자동실행됨
	sock.onopen = function() {
		console.log('onopen 실행됨');
		sock.send(JSON.stringify({
			chatRoomId : roomId,
			type : "JOIN"
		}));
	}
	
	//onmessage 함수는 메시지가 오면 자동실행됨
	sock.onmessage = function(e) {
		console.log("onmsg 실행");
		
		var chatroom_seq = $("#roomName").val();
		console.log(chatroom_seq);
		
		
		var content = JSON.parse(e.data);
		var message = content.message;
		var type = content.type;
		//var chatLog = document.getElementById("chatLog");
		if (type == "SEND")
			appendMessage(message);
		
		//ajax 호출하여 DB에 넣기
		$.ajax({
			
			alert('실행');
			
			url : "multiRoom/insertMsg",
			type : "POST",
			data : {
				chatroom_seq : roomId,
				chatmsg_content : message
			},
			dataType : 'json',
			success : function(result) {
				console.log('DB 삽입 완료');
			}
		});
	}
	
	//send 함수
	function send() {
		console.log("send 실행");
		var textarea = document.getElementById("textarea");
		var myMessage = textarea.value;
		console.log(myMessage);
		
		sock.send(JSON.stringify({
			chatRoomId : roomId,
			type : "SEND",
			message : myMessage
		}));
	}
	
	//보낸 시간 형식 만드는 함수
	function getTimeStamp() {
		var d = new Date();
		var s = leadingZeros(d.getFullYear(), 4) + '-'
				+ leadingZeros(d.getMonth() + 1, 2) + '-'
				+ leadingZeros(d.getDate(), 2) + ' ' +

				leadingZeros(d.getHours(), 2) + ':'
				+ leadingZeros(d.getMinutes(), 2) + ':'
				+ leadingZeros(d.getSeconds(), 2);

		return s;
		console.log(s);
	}

	//0 처리하기
	function leadingZeros(n, digits) {
		var zero = '';
		n = n.toString();

		if (n.length < digits) {
			for (i = 0; i < digits - n.length; i++)
				zero += '0';
		}
		return zero + n;
	}
	
	//메시지 append
	function appendMessage(msg) {

			if (msg == '') {
				return false;
			} else {

				var t = getTimeStamp();
				$("#chatLog")
						.append(
								"<div class='col-12 row' style = 'height : auto; margin-top : 5px;'><div class='col-2' style = 'float:left; padding-right:0px; padding-left : 0px;'><div style='font-size:9px; clear:both;'>${user_name}</div></div><div class = 'col-10' style = 'overflow : y ; margin-top : 7px; float:right;'><div class = 'col-12' style = ' background-color:#ACF3FF; padding : 10px 5px; float:left; border-radius:10px;'><span style = 'font-size : 12px;'>"
										+ msg
										+ "</span></div><div col-12 style = 'font-size:9px; text-align:right; float:right;'><span style ='float:right; font-size:9px; text-align:right;' >"
										+ t + "</span></div></div></div>")

				var chatAreaHeight = $("#chatArea").height();
				var maxScroll = $("#chatLog").height() - chatAreaHeight;
				$("#chatArea").scrollTop(maxScroll);

			}
		}
</script>
</head>
<body>
	<input type="hidden" id="roomId" value="${roomid}">
	<h1>대화방</h1>
	<div class="col-12">
		<div class="col-11"
			style="margin: 0 auto; border: 1px solid #01D1FE; height: 400px; border-radius: 10px; overflow: scroll"
			id="chatArea">
			<div id="chatLog" style="margin-top: 10px; margin-left: 10px;"></div>
		</div>
	</div>
		<textarea class="form-control"
			style="border: 1px solid #01D1FE; height: 65px; float: left; width: 80%"
			placeholder="Enter ..." id="textarea"></textarea>
		<input type="button" id="chatArea" value="전송" onclick="send()">
</body>
</html>