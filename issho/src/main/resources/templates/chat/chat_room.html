<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<th:block th:replace="fragments/config :: head"></th:block>
<meta charset="UTF-8">
<title>Insert title here</title>
<script th:src="@{/js/sockjs.min.js}"></script>
<script th:inline="javascript">
	let roomId = [[${roomId}]];
	let sock = new SockJS("../../ws/multiRoom");

	console.log(sock);
	console.log(roomId);
	
	//onopen 함수는 페이지가 로드되면 자동실행됨
	sock.onopen = function() {
		console.log('onopen 실행됨');
		sock.send(JSON.stringify({
			chatRoomId : roomId,
			type : "JOIN"
		}));
	}
	
	//onmessage 함수는 메시지가 오면 자동실행됨
	sock.onmessage = function(e) {
		console.log("onmsg 실행");

		console.log("onmsg roomId :" + roomId);
		
		var content = JSON.parse(e.data);
		var message = content.message;
		var type = content.type;
		//var chatLog = document.getElementById("chatLog");
		if (type == "SEND")
			appendMessage(message);
		
		
		//ajax 호출하여 DB에 넣기
		$.ajax({
			url : "multiRoom/insertMsg",
			type : "POST",
			data : {
				chatroom_seq : roomId,
				chatmsg_content : message
			},
			dataType : 'json',
			success : function(result) {
				console.log('DB 삽입 완료');
			}
		});
	}
	
	//send 함수
	function send() {
		console.log("send 실행");
		var textarea = document.getElementById("textarea");
		var myMessage = textarea.value;
		console.log(myMessage);
		
		sock.send(JSON.stringify({
			chatRoomId : roomId,
			type : "SEND",
			message : myMessage
		}));
	}
	

	//메시지 append
	function appendMessage(msg) {

			if (msg == '') {
				return false;
			} else {

				//var t = getTimeStamp();
				$("#chatLog")
						.append(
								"<div class='col-12 row' style = 'height : auto; margin-top : 5px;'><div class='col-2' style = 'float:left; padding-right:0px; padding-left : 0px;'><div style='font-size:9px; clear:both;'>${user_name}</div></div><div class = 'col-10' style = 'overflow : y ; margin-top : 7px; float:right;'><div class = 'col-12' style = ' background-color:#ACF3FF; padding : 10px 5px; float:left; border-radius:10px;'><span style = 'font-size : 12px;'>"
										+ msg
										+ "</span></div><div col-12 style = 'font-size:9px; text-align:right; float:right;'><span style ='float:right; font-size:9px; text-align:right;' >")
										//+ t + "</span></div></div></div>")

				var chatAreaHeight = $("#chatArea").height();
				var maxScroll = $("#chatLog").height() - chatAreaHeight;
				$("#chatArea").scrollTop(maxScroll);

			}
		}
</script>
</head>
<body>
	<input type="hidden" id="roomId" value="${roomid}">
	<div>
		<h1>대화방</h1>
	</div>
	<div>
		<div style="height: 700px; overflow: scroll; overflow-x:hidden; background-color : #f1f3f5" id="chatArea">
			<div id="chatLog" style="margin-top: 10px; margin-left: 10px;"></div>
		</div>
	</div>
	<textarea class="form-control"
		style="height: 100px; float: left; width: 90%; border : none; margin : 5px; resize : none;"placeholder="메시지를 입력해주세요" 
		id="textarea"></textarea>
	<button type="button" id="chatArea" class="btn btn-info btn-lg" onclick="send()">전송</button>
</body>
</html>