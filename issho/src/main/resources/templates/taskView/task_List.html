<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<th:block th:replace="fragments/config :: head"></th:block>
<!-- bootstrap 4 -->
<link rel="stylesheet"
	href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<!-- gijgo datepicker library -->
<script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js"
	type="text/javascript"></script>
<link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css"
	rel="stylesheet" type="text/css" />
<meta charset="UTF-8">
<style>
#basicSelection, #basicSelection2, #basicSelection3, #basicSelection4,
	#basicSelection5 {
	margin-right: 10px;
}

#staffNotice {
	margin-left: 10px;
}

ul#memList li.mem-item {
	padding: 4px 8px 5px;
	background-color: #4CD3E3;
	color: white;
	border-radius: 30px;
	margin: 10px 5px 0 0;
	display: inline-block;
	font-size: 14px;
	letter-spacing: -.5px;
}

ul#memList li.mem-item:hover {
	background-color: white;
	color: #4CD3E3;
	border: 1px solid #4CD3E3;
}
</style>
<title>Insert title here</title>
</head>
<body>
	<div id="wrapper">
		<!-- content 시작 -->
		<th:block th:replace="fragments/sidebar :: sidebar"></th:block>
		<!-- content 끝 -->

		<div id="content-wrapper" class="d-flex flex-column">
			<!-- header 시작 -->
			<nav th:fragment="navFragment"
				class="navbar navbar-expand navbar-light bg-white topbar static-top shadow">

				<!-- Sidebar Toggle (Topbar) -->
				<button id="sidebarToggleTop"
					class="btn btn-link d-md-none rounded-circle mr-3">
					<i class="fa fa-bars"></i>
				</button>


				<!-- Topbar Navbar -->
				<ul class="navbar-nav ml-auto">

					<!-- Nav Item - Alerts -->
					<li class="nav-item dropdown no-arrow mx-1"><a
						class="nav-link dropdown-toggle" href="#" id="alertsDropdown"
						role="button" data-toggle="dropdown" aria-haspopup="true"
						aria-expanded="false"> <i class="fas fa-bell fa-fw"></i> <!-- Counter - Alerts -->
							<span class="badge badge-danger badge-counter">3+</span>
					</a> <!-- Dropdown - Alerts -->
						<div
							class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
							aria-labelledby="alertsDropdown">
							<h6 class="dropdown-header">Alerts Center</h6>
							<a class="dropdown-item d-flex align-items-center" href="#">
								<div class="mr-3">
									<div class="icon-circle bg-primary">
										<i class="fas fa-file-alt text-white"></i>
									</div>
								</div>
								<div>
									<div class="small text-gray-500">December 12, 2019</div>
									<span class="font-weight-bold">A new monthly report is
										ready to download!</span>
								</div>
							</a> <a class="dropdown-item d-flex align-items-center" href="#">
								<div class="mr-3">
									<div class="icon-circle bg-success">
										<i class="fas fa-donate text-white"></i>
									</div>
								</div>
								<div>
									<div class="small text-gray-500">December 7, 2019</div>
									$290.29 has been deposited into your account!
								</div>
							</a> <a class="dropdown-item d-flex align-items-center" href="#">
								<div class="mr-3">
									<div class="icon-circle bg-warning">
										<i class="fas fa-exclamation-triangle text-white"></i>
									</div>
								</div>
								<div>
									<div class="small text-gray-500">December 2, 2019</div>
									Spending Alert: We've noticed unusually high spending for your
									account.
								</div>
							</a> <a class="dropdown-item text-center small text-gray-500"
								href="#">Show All Alerts</a>
						</div></li>

					<!-- Nav Item - Messages -->
					<li class="nav-item dropdown no-arrow mx-1"><a
						class="nav-link dropdown-toggle" href="#" id="messagesDropdown"
						role="button" data-toggle="dropdown" aria-haspopup="true"
						aria-expanded="false"> <i class="fas fa-envelope fa-fw"></i> <!-- Counter - Messages -->
							<span class="badge badge-danger badge-counter">7</span>
					</a> <!-- Dropdown - Messages -->
						<div
							class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
							aria-labelledby="messagesDropdown">
							<h6 class="dropdown-header">Message Center</h6>
							<a class="dropdown-item d-flex align-items-center" href="#">
								<div class="dropdown-list-image mr-3">
									<img class="rounded-circle"
										th:src="@{/img/undraw_profile_1.svg}" alt="...">
									<div class="status-indicator bg-success"></div>
								</div>
								<div class="font-weight-bold">
									<div class="text-truncate">Hi there! I am wondering if
										you can help me with a problem I've been having.</div>
									<div class="small text-gray-500">Emily Fowler · 58m</div>
								</div>
							</a> <a class="dropdown-item d-flex align-items-center" href="#">
								<div class="dropdown-list-image mr-3">
									<img class="rounded-circle"
										th:src="@{/img/undraw_profile_2.svg}" alt="...">
									<div class="status-indicator"></div>
								</div>
								<div>
									<div class="text-truncate">I have the photos that you
										ordered last month, how would you like them sent to you?</div>
									<div class="small text-gray-500">Jae Chun · 1d</div>
								</div>
							</a> <a class="dropdown-item d-flex align-items-center" href="#">
								<div class="dropdown-list-image mr-3">
									<img class="rounded-circle"
										th:src="@{/img/undraw_profile_3.svg}" alt="...">
									<div class="status-indicator bg-warning"></div>
								</div>
								<div>
									<div class="text-truncate">Last month's report looks
										great, I am very happy with the progress so far, keep up the
										good work!</div>
									<div class="small text-gray-500">Morgan Alvarez · 2d</div>
								</div>
							</a> <a class="dropdown-item d-flex align-items-center" href="#">
								<div class="dropdown-list-image mr-3">
									<img class="rounded-circle"
										src="https://source.unsplash.com/Mv9hjnEUHR4/60x60" alt="...">
									<div class="status-indicator bg-success"></div>
								</div>
								<div>
									<div class="text-truncate">Am I a good boy? The reason I
										ask is because someone told me that people say this to all
										dogs, even if they aren't good...</div>
									<div class="small text-gray-500">Chicken the Dog · 2w</div>
								</div>
							</a> <a class="dropdown-item text-center small text-gray-500"
								href="#">Read More Messages</a>
						</div></li>

					<div class="topbar-divider d-none d-sm-block"></div>

					<!-- Nav Item - User Information -->
					<li class="nav-item dropdown no-arrow"><a
						class="nav-link dropdown-toggle" href="#" id="userDropdown"
						role="button" data-toggle="dropdown" aria-haspopup="true"
						aria-expanded="false"> <span
							class="mr-2 d-none d-lg-inline text-gray-600 small">Username</span>
							<img class="img-profile rounded-circle"
							th:src="@{/img/undraw_profile.svg}">
					</a> <!-- Dropdown - User Information -->
						<div
							class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
							aria-labelledby="userDropdown">
							<a class="dropdown-item" href="#"> <i
								class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i> 마이페이지
							</a> <a class="dropdown-item" href="#"> <i
								class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i> 화상채팅
							</a>
							<div class="dropdown-divider"></div>
							<a class="dropdown-item" href="#" data-toggle="modal"
								data-target="#logoutModal"> <i
								class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
								로그아웃
							</a>
						</div></li>
				</ul>
			</nav>
			<nav class="navbar navbar-expand-lg"
				style="background-color: #f1f3f5; border-bottom: solid 2px black;">
				<div>
					<!-- 태스크 추가 modal trigger -->
					<button class="btn btn-primary" id="newTask" data-bs-toggle="modal"
						data-bs-target="exampleModal">
						<i class="fa-solid fa-plus"></i>태스크 추가
					</button>
				</div>
			</nav>
			<div class="col-xl-7 col-md-6 m-4">
				<div class="card shadow h-20 py-2">
					<div class="card-body">
						<div class="row no-gutters align-items-center">
							<div class="col mr-2">
								<div
									class="text-xs font-weight-bold text-primary text-uppercase mb-1">
									태스크 111</div>
								<div class="h5 mb-0 font-weight-bold text-gray-800">할당자
									111</div>
							</div>
							<div class="col-auto">
								<i class="fas fa-calendar fa-2x text-gray-300"></i>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- 태스크 추가 modal -->
			<div class="modal fade" id="exampleModal" tabindex="-1"
				aria-labelledby="exampleModalLabel" aria-hidden="true">

				<form th:action="@{/task/addNewTask}" method="POST" id="newTaskForm"
					enctype="multipart/form-data">
					<div class="modal-dialog modal-lg">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="exampleModalLabel">새로운 태스크 추가</h5>
								<button type="button" class="btn-close" data-bs-dismiss="modal"
									aria-label="Close"></button>
							</div>
							<div class="modal-body">
								<!-- 할당자 -->
								<div class="input-group m-3">
									<div class="input-group-prepend">
										<span class="input-group-text" id="basic-addon1">할당자</span>
									</div>
									<input type="text" class="form-control" readonly
										th:value="${member.memb_name} + ${member.memb_mail}"
										aria-label="Username" aria-describedby="basic-addon1">
								</div>

								<div class="input-group m-3">
									<div class="input-group-prepend">
										<span class="input-group-text" id="basic-addon1"
											onclick="showAddMember();">담당자</span> <span id="staffNotice">담당자를
											추가하지 않을 시, 업무 할당자 본인이 담당자로 배정됩니다.</span>
										<div id="mems">
											<ul id="memList">
											</ul>
										</div>

										<input type="hidden" id="memList2" name="memList2" value="">
									</div>

								</div>

								<div id="memDiv">
									<input type="text" class="form-control" id="staffInput"
										name="staffs" placeholder="아이디 또는 이름으로 멤버를 검색하세요"
										aria-label="Username" value="" aria-describedby="basic-addon1">
									<div id="chatMem"
										style="overflow: auto; width: 100%; height: 200px; margin: 10px;">

										<table class="table table-hover">
											<tr th:each="list : ${list}" th:id="${list.memb_mail}"
												th:name="${list.memb_name}" onclick="appendMem(id);">
												<td th:text="${list.memb_ogfile}"></td>
												<td th:text="${list.memb_name}"></td>
												<td th:text="${list.memb_mail}"></td>
											</tr>
										</table>
									</div>
								</div>

								<div class="input-group m-3">
									<div class="input-group-prepend">
										<span class="input-group-text" id="basic-addon1">제목</span>
									</div>
									<input type="text" class="form-control" name="task_name"
										placeholder="태스크 제목을 입력하세요" aria-label="Username" required
										aria-describedby="basic-addon1">
								</div>

								<div class="input-group m-3">
									<div class="input-group-prepend">
										<span class="input-group-text" id="basicSelection">우선순위</span>
									</div>
									<div class="btn-group btn-group-toggle" data-toggle="buttons">
										<label class="btn btn-outline-info"> <input
											type="radio" name="task_rank" class="radioSelection"
											checked="checked" id="priority1" value="0"> 낮음
										</label> <label class="btn btn-outline-info"> <input
											type="radio" name="task_rank" class="radioSelection"
											id="priority2" value="1">보통
										</label> <label class="btn btn-outline-info"> <input
											type="radio" name="task_rank" class="radioSelection"
											id="priority3" value="2"> 높음
										</label>
									</div>
								</div>


								<div class="input-group m-3">
									<div class="input-group-prepend">
										<span class="input-group-text" id="basicSelection2">진행도</span>
									</div>
									<div class="btn-group btn-group-toggle" data-toggle="buttons">
										<label class="btn btn-outline-secondary"> <input
											type="radio" name="task_state" class="radioSelection"
											checked="checked" id="yet" value="0"> 진행전
										</label> <label class="btn btn-outline-secondary"> <input
											type="radio" name="task_state" class="radioSelection"
											id="ongoing" value="1"> 진행중
										</label> <label class="btn btn-outline-secondary"> <input
											type="radio" name="task_state" class="radioSelection"
											id="done" value="2"> 완료
										</label> <label class="btn btn-outline-secondary"> <input
											type="radio" name="task_state" class="radioSelection"
											id="pending" value="3"> 보류
										</label>
									</div>
								</div>

								<div class="input-group m-3" id="start">
									<div class="input-group-prepend">
										<span class="input-group-text" id="basicSelection4">예상시작일</span>
										<input type="radio" id="startNone" name="chk_startDate"
											value="0" checked="checked">없음 <input type="radio"
											id="startExist" name="chk_startDate" value="1">있음 <input
											id="datepicker" width="150" name="exp_startdate"
											style="margin-left: 20px;" />
									</div>
								</div>

								<div class="input-group m-3" id="end">
									<div class="input-group-prepend">
										<span class="input-group-text" id="basicSelection5">예상종료일</span>
										<input type="radio" name="chk_endDate" id="endNone" value="0"
											checked="checked">없음 <input type="radio"
											id="endExist" name="chk_endDate" value="1">있음 <input
											id="datepicker2" width="150" name="exp_enddate"
											style="margin-left: 20px;" />
									</div>
								</div>

								<div class="input-group m-3" id="files">
									<div class="input-group-prepend">
										<span class="input-group-text" id="basicSelection3">첨부파일</span>
									</div>
									<input type="file" name="uploads">
									<button type="button" class="btn btn-success btn-circle btn-sm"
										onclick="addNewFileInput()">+</button>
								</div>

								<div class="input-group m-3">
									<textarea class="form-control" id="exampleFormControlTextarea1"
										name="task_content" rows="5">내용을 입력하세요</textarea>
								</div>
							</div>

							<div class="modal-footer">
								<button type="button" id="closeNewTask"
									class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
								<button type="button" class="btn btn-primary"
									onclick="submitForm();">등록</button>
							</div>
					</form>
				</div>
			</div>
		</div>
	<!-- header 끝 -->
	<!-- footer 시작 -->
	<th:block th:replace="fragments/footer :: footerFragment"></th:block>
	<!-- footer 끝 -->
	</div>
	</div>

	<script>
		//파일 업로드 개수
		let fileCount = 0;

		//멤버 검색창 오픈 여부
		let isOpened = false;
		$("#memDiv").hide();

		//datepicker 달력 숨겨두기
		$("#datepicker").hide();
		$("#datepicker2").hide();

		//새로운 태스크 모달창 제어
		$("#newTask").click(function(e) {
			e.preventDefault();
			$("#exampleModal").modal("show");
		});

		$("#closeNewTask").click(function(e) {
			e.preventDefault();
			$("#exampleModal").modal("hide");
		});

		//예상 시작일/종료일 제어
		$("#startNone").change(function() {
			$("#datepicker").hide();
			$(".gj-icon").hide();
		});

		$("#startExist").change(function() {

			$("#datepicker").show();
			$('#datepicker').datepicker({format : 'yyyy-mm-dd'});
			$(".gj-icon").show();
		});

		$("#endNone").change(function() {
			$("#datepicker2").hide();
			$(".gj-icon").hide();
		});

		$("#endExist").change(function() {
			$("#datepicker2").show();
			$('#datepicker2').datepicker({format : 'yyyy-mm-dd'});
			$(".gj-icon").show();
		});

		//진행상태에 따른 시작/종료일 제어
		$("#ongoing").change(function() {
			$("#basicSelection4").text("시작일");
			$("#basicSelection5").text("예상종료일");
		});

		$("#yet").change(function() {
			$("#basicSelection4").text("예상시작일");
			$("#basicSelection5").text("예상종료일");
		});

		$("#done").change(function() {
			$("#basicSelection4").text("시작일");
			$("#basicSelection5").text("종료일");
		});

		$("#pending").change(function() {
			$("#basicSelection4").text("예상시작일");
			$("#basicSelection5").text("예상종료일");
		});

		//담당자 검색 ajax
		$("#staffInput").keyup(function() {
			console.log('keyup 실행');
			
			let val = $("#staffInput").val();
			
			$.ajax({
				url : '../member/memSearchByIdName',
				type : 'POST',
				data : {
					searchWord : val
				},
				success : function(list){
					let content = '';
					let result = $("#chatMem");
					
					result.empty();
					
					$.each(list, function(i, list){
						content += '<table><tr><td>' + list.memb_ogfile + '<td>'
						+ list.memb_name + '</td><td>' + list.memb_mail + '</td></tr></table>'
					});
					
					result.html(content);
				}
				
			})

		});

		//
		function showAddMember() {

			if (isOpened) {
				$("#memDiv").hide();
				isOpened = false;
			} else {
				$("#memDiv").show();
				isOpened = true;
			}
		}

		function appendMem(id) {

			$("#staffNotice").hide();

			console.log('appendMem 실행됨' + id);

			var list = document.querySelectorAll('li.mem-item');

			let memLists = new Array();

			for (var i = 0; i < list.length; i++) {
				memLists[i] = list[i].id;
			}

			var li = $("#memList2").val();

			if (memLists.includes(id)) {

				alert('이미 추가된 멤버입니다.');

			} else {

				li += id + ",";

				$("#memList2").val(li);

				$
						.ajax({
							url : "../member/memSearch",
							type : "POST",
							data : {
								memb_mail : id
							},
							success : function(result) {
								$("#memList")
										.append(
												"<li class='mem-item' id= "+ id +  ">"
														+ "<span>"
														+ result
														+ "</span>"
														+ "<span class='del-btn' idx='" + id + "'>&nbsp;x</span></li>");
							}
						});
			}
		}

		$(document).on("click", ".del-btn", function(e) {
			var index = $(this).attr("idx");
			$(this).parent().remove();
		});

		//체크리스트
		function addCheckList() {

		}

		//file 태그 추가
		function addNewFileInput() {

			if (fileCount < 4) {
				$("#files").append("<input type='file' name='uploads'>");
				fileCount++;
			} else {
				alert('파일은 최대 다섯 개 첨부할 수 있습니다.');
			}
		}

		//form 전송
		function submitForm() {

			$("#newTaskForm").submit();

			alert('성공적으로 등록되었습니다.');

			$("#exampleModal").modal("hide");
		}
	</script>
</body>
</html>